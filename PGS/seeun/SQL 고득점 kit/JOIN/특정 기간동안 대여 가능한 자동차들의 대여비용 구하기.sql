SELECT  C.CAR_ID, C.CAR_TYPE, TRUNC(C.DAILY_FEE*((100-P.DISCOUNT_RATE)/100)*30, 0) AS FEE
FROM CAR_RENTAL_COMPANY_CAR C JOIN CAR_RENTAL_COMPANY_DISCOUNT_PLAN P
ON C.CAR_TYPE = P.CAR_TYPE
WHERE C.CAR_ID NOT IN ( -- 렌탈 기간이 11월에 겹치는 렌트카 제외
    SELECT CAR_ID
    FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY 
    WHERE to_char(START_DATE, 'YYYYMMDD') <= '20221130' -- 시작 날짜가 11월 30일 이전이고
    AND to_char(END_DATE, 'YYYYMMDD') >= '20221101') -- 끝 날짜가 11월 1일 이후인 
AND (C.CAR_TYPE = 'SUV' OR C.CAR_TYPE='세단') -- 세단이나 SUV
AND REGEXP_REPLACE(P.DURATION_TYPE, '[^0-9]') = 30 -- 할인 대여기간이 30일 이상
GROUP BY  C.CAR_ID, C.CAR_TYPE, TRUNC(C.DAILY_FEE*((100-P.DISCOUNT_RATE)/100)*30, 0)
HAVING  TRUNC(C.DAILY_FEE*((100-P.DISCOUNT_RATE)/100)*30, 0) >= 500000 AND  TRUNC(C.DAILY_FEE*((100-P.DISCOUNT_RATE)/100)*30, 0) < 2000000 -- 50만원 이상 200만원 미만
ORDER BY 3 DESC, 2, 1 DESC